# ğŸ¨ Authentication System Visual Flow Diagrams

## ğŸ“Š Complete System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FIXER AUTH SYSTEM ARCHITECTURE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         USER TYPES & ROLES                            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   ğŸ‘‘ SUPER ADMIN (54 perms)  â†â”€â”€â”€â”€ Database Seeded                   â”‚  â”‚
â”‚  â”‚          â”‚                                                             â”‚  â”‚
â”‚  â”‚          â”œâ”€â†’ ğŸ›¡ï¸  ADMIN (52 perms)  â†â”€â”€â”€â”€ Approved by Super Admin    â”‚  â”‚
â”‚  â”‚          â”‚                                                             â”‚  â”‚
â”‚  â”‚          â”œâ”€â†’ ğŸ“‹ MODERATOR (22 perms) â†â”€â”€ Approved by Admin           â”‚  â”‚
â”‚  â”‚          â”‚                                                             â”‚  â”‚
â”‚  â”‚          â”œâ”€â†’ ğŸ”§ PROVIDER (25 perms)  â†â”€â”€ Approved by Admin           â”‚  â”‚
â”‚  â”‚          â”‚                                                             â”‚  â”‚
â”‚  â”‚          â””â”€â†’ ğŸ›’ CUSTOMER (19 perms)  â†â”€â”€ Auto-Approved               â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚              ğŸ‘ï¸  GUEST (4 perms)     â†â”€â”€ No Auth Required            â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     REQUEST FLOW WITH MIDDLEWARE                      â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚   HTTP Request                                                         â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   [Rate Limiter] â”€â”€âŒâ”€â†’ 429 Too Many Requests                        â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   [Input Validation] â”€â”€âŒâ”€â†’ 400 Bad Request                          â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   [JWT Authentication] â”€â”€âŒâ”€â†’ 401 Unauthorized                        â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   [RBAC Permission Check] â”€â”€âŒâ”€â†’ 403 Forbidden                        â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   [Controller] â†’ [Service] â†’ [Repository] â†’ [Database]                â”‚  â”‚
â”‚  â”‚        â”‚                                                               â”‚  â”‚
â”‚  â”‚        â–¼                                                               â”‚  â”‚
â”‚  â”‚   200 OK / 201 Created                                                 â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš¦ User Registration & Approval Flows

### Flow 1: Customer Registration (Auto-Approved) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CUSTOMER REGISTRATION FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   User                    API                     Database              Output
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  POST /auth/register  â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚  {user_type:customer} â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Check Email Exists      â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… Not Found            â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Hash Password           â”‚                    â”‚
    â”‚                       â”‚  (bcrypt, 12 rounds)     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Create User             â”‚                    â”‚
    â”‚                       â”‚  approval_status='approved'                   â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… User Created         â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Assign "customer" Role  â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… Role Assigned        â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Generate JWT Tokens     â”‚                    â”‚
    â”‚                       â”‚  (access + refresh)      â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  201 Created          â”‚                          â”‚                    â”‚
    â”‚  + User Data          â”‚                          â”‚                    â”‚
    â”‚  + JWT Tokens         â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼
 âœ… Can login           âœ… Approved               âœ… Role in DB        âœ… Success
 immediately            instantly                 user_roles table     requiresApproval=false
```

---

### Flow 2: Provider Registration (Requires Approval) â³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROVIDER REGISTRATION FLOW                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Provider                API                     Database              Admin
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  POST /auth/register  â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚  {user_type:provider} â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Check Email/Phone       â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… Not Found            â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Hash Password           â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Create User             â”‚                    â”‚
    â”‚                       â”‚  approval_status='pending'                    â”‚
    â”‚                       â”‚  is_verified=false       â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… User Created         â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Create Approval Request â”‚                    â”‚
    â”‚                       â”‚  status='pending'        â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  âœ… Approval Created     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  ğŸš« NO JWT Generated     â”‚                    â”‚
    â”‚                       â”‚  ğŸš« NO Role Assigned     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  201 Created          â”‚                          â”‚                    â”‚
    â”‚  requiresApproval=trueâ”‚                          â”‚    ğŸ“§ Notify       â”‚
    â”‚  tokens=null          â”‚                          â”‚    (future)        â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  â³ Wait for approval â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  âŒ Cannot login yet  â”‚                          â”‚  Admin reviews     â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  GET /admin/approvals/   â”‚                    â”‚
    â”‚                       â”‚  pending                 â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                       â”‚  [list of pending users] â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  POST /admin/approvals/  â”‚                    â”‚
    â”‚                       â”‚  {id}/approve            â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Update User:            â”‚                    â”‚
    â”‚                       â”‚  approval_status='approved'                   â”‚
    â”‚                       â”‚  is_verified=true        â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Assign "provider" Role  â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Update Approval:        â”‚                    â”‚
    â”‚                       â”‚  status='approved'       â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  ğŸ“§ Email Notificationâ”‚                          â”‚                    â”‚
    â”‚  "You're approved!"   â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  Now POST /auth/login â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚                       â”‚  âœ… Generate JWT         â”‚                    â”‚
    â”‚  200 OK + tokens      â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼
 âœ… Can now login      âœ… Approved              âœ… Role assigned    âœ… Provider
 and use platform      after review            in database         onboarded
```

---

## ğŸ” Login Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LOGIN AUTHENTICATION FLOW                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   User                    API                     Database              Output
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  POST /auth/login     â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚  {email, password}    â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Find User by Email      â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  User Record             â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Compare Password        â”‚                    â”‚
    â”‚                       â”‚  bcrypt.compare()        â”‚                    â”‚
    â”‚                       â”‚  âœ… Match                â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Check approval_status   â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  approval_status='approved' âœ…                â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Generate JWT Tokens:    â”‚                    â”‚
    â”‚                       â”‚  - Access Token (15m)    â”‚                    â”‚
    â”‚                       â”‚  - Refresh Token (7d)    â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Payload: {              â”‚                    â”‚
    â”‚                       â”‚    userId,               â”‚                    â”‚
    â”‚                       â”‚    email,                â”‚                    â”‚
    â”‚                       â”‚    userType              â”‚                    â”‚
    â”‚                       â”‚  }                       â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  200 OK               â”‚                          â”‚                    â”‚
    â”‚  {                    â”‚                          â”‚                    â”‚
    â”‚    user: {...},       â”‚                          â”‚                    â”‚
    â”‚    tokens: {          â”‚                          â”‚                    â”‚
    â”‚      accessToken,     â”‚                          â”‚                    â”‚
    â”‚      refreshToken     â”‚                          â”‚                    â”‚
    â”‚    }                  â”‚                          â”‚                    â”‚
    â”‚  }                    â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼
 âœ… Store tokens        âœ… Session started       âœ… Auth complete     âœ… Success
 in secure storage      (stateless JWT)         user authenticated   200 OK


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FAILED LOGIN SCENARIOS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Scenario                     Reason                         Response
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   âŒ User not found            Email doesn't exist            401 Invalid email or password
   
   âŒ Wrong password            Password mismatch              401 Invalid email or password
   
   âŒ Not approved yet          approval_status='pending'      401 Account pending approval
   
   âŒ Account rejected          approval_status='rejected'     401 Account application rejected
   
   âŒ Rate limit exceeded       Too many login attempts        429 Too many requests
```

---

## ğŸ”‘ Permission Check Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              RBAC PERMISSION CHECK MIDDLEWARE FLOW                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Request                 Middleware              Database              Response
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  GET /admin/approvals â”‚                          â”‚                    â”‚
    â”‚  Authorization: Bearerâ”‚                          â”‚                    â”‚
    â”‚  <JWT>                â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  [authenticateToken]     â”‚                    â”‚
    â”‚                       â”‚  1. Extract JWT          â”‚                    â”‚
    â”‚                       â”‚  2. Verify signature     â”‚                    â”‚
    â”‚                       â”‚  3. Check expiration     â”‚                    â”‚
    â”‚                       â”‚  âœ… Valid                â”‚                    â”‚
    â”‚                       â”‚  Extract userId          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  [requirePermission]     â”‚                    â”‚
    â”‚                       â”‚  Required: user:approve  â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Query user_roles        â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  user has role_id: X     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Query role_permissions  â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  role X has permissions: â”‚                    â”‚
    â”‚                       â”‚  [user:create,           â”‚                    â”‚
    â”‚                       â”‚   user:read,             â”‚                    â”‚
    â”‚                       â”‚   user:approve, ...]     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Check if user:approve   â”‚                    â”‚
    â”‚                       â”‚  in permissions list     â”‚                    â”‚
    â”‚                       â”‚  âœ… FOUND                â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  âœ… Allow request        â”‚                    â”‚
    â”‚                       â”‚  Pass to controller      â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  200 OK               â”‚                          â”‚                    â”‚
    â”‚  [pending approvals]  â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PERMISSION DENIED SCENARIO                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Customer                Middleware              Database              Response
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  GET /admin/approvals â”‚                          â”‚                    â”‚
    â”‚  Authorization: Bearerâ”‚                          â”‚                    â”‚
    â”‚  <CUSTOMER_JWT>       â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  [authenticateToken]     â”‚                    â”‚
    â”‚                       â”‚  âœ… Valid JWT            â”‚                    â”‚
    â”‚                       â”‚  userId extracted        â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  [requirePermission]     â”‚                    â”‚
    â”‚                       â”‚  Required: user:approve  â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Query user roles        â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  role: "customer"        â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Query customer perms    â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  permissions: [          â”‚                    â”‚
    â”‚                       â”‚   service_request:create,â”‚                    â”‚
    â”‚                       â”‚   quote:read,            â”‚                    â”‚
    â”‚                       â”‚   booking:create, ...    â”‚                    â”‚
    â”‚                       â”‚  ]                       â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Check if user:approve   â”‚                    â”‚
    â”‚                       â”‚  in permissions list     â”‚                    â”‚
    â”‚                       â”‚  âŒ NOT FOUND            â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  403 Forbidden        â”‚                          â”‚                    â”‚
    â”‚  {                    â”‚                          â”‚                    â”‚
    â”‚    success: false,    â”‚                          â”‚                    â”‚
    â”‚    message: "Permission denied"                  â”‚                    â”‚
    â”‚  }                    â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼
 âŒ Access Denied       âŒ Permission missing    âŒ Authorization      âŒ Forbidden
 Cannot approve users   customer role lacks     failed                403 Error
                        user:approve
```

---

## ğŸ”„ Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     JWT TOKEN REFRESH FLOW                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Client                  API                     Database              Output
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  Access Token Expired â”‚                          â”‚                    â”‚
    â”‚  âŒ 401 Unauthorized  â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  POST /auth/refresh   â”‚                          â”‚                    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚                    â”‚
    â”‚  {refreshToken}       â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Verify Refresh Token    â”‚                    â”‚
    â”‚                       â”‚  - Signature valid?      â”‚                    â”‚
    â”‚                       â”‚  - Not expired?          â”‚                    â”‚
    â”‚                       â”‚  âœ… Valid                â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Extract userId          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Get User                â”‚                    â”‚
    â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
    â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
    â”‚                       â”‚  User still exists âœ…    â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚                       â”‚  Generate NEW Tokens:    â”‚                    â”‚
    â”‚                       â”‚  - New Access Token      â”‚                    â”‚
    â”‚                       â”‚  - New Refresh Token     â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  200 OK               â”‚                          â”‚                    â”‚
    â”‚  {                    â”‚                          â”‚                    â”‚
    â”‚    tokens: {          â”‚                          â”‚                    â”‚
    â”‚      accessToken,     â”‚                          â”‚                    â”‚
    â”‚      refreshToken     â”‚                          â”‚                    â”‚
    â”‚    }                  â”‚                          â”‚                    â”‚
    â”‚  }                    â”‚                          â”‚                    â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â”‚  Store new tokens     â”‚                          â”‚                    â”‚
    â”‚  Continue using API   â”‚                          â”‚                    â”‚
    â”‚                       â”‚                          â”‚                    â”‚
    â–¼                       â–¼                          â–¼                    â–¼
 âœ… New tokens          âœ… Session extended     âœ… User verified      âœ… Success
 replaced old ones      without re-login       still active          seamless
```

---

## ğŸ—ï¸ Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      RBAC DATABASE SCHEMA                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ email            â”‚         â”‚
â”‚ password_hash    â”‚         â”‚
â”‚ user_type        â”‚         â”‚
â”‚ approval_status  â”‚         â”‚
â”‚ is_verified      â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚                    â”‚
         â”‚                    â”‚
         â”‚                    â”‚
         â–¼                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   user_roles     â”‚         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚ id (PK)          â”‚         â”‚
â”‚ user_id (FK) â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ role_id (FK) â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ assigned_by      â”‚         â”‚
â”‚ is_active        â”‚         â”‚
â”‚ expires_at       â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      roles       â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ id (PK)          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ name             â”‚         â”‚
                    â”‚ description      â”‚         â”‚
                    â”‚ is_active        â”‚         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                              â”‚                   â”‚
                              â”‚                   â”‚
                              â–¼                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                    â”‚ role_permissions â”‚         â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
                    â”‚ id (PK)          â”‚         â”‚
                    â”‚ role_id (FK) â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ permission_id (FK)â”€â”€â”
                    â”‚ granted          â”‚  â”‚
                    â”‚ conditions       â”‚  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                           â”‚
                                           â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚   permissions    â”‚
                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                 â”‚ id (PK)          â”‚
                                 â”‚ name             â”‚
                                 â”‚ resource         â”‚
                                 â”‚ action           â”‚
                                 â”‚ is_active        â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_approvals   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚
â”‚ user_id (FK) â”€â”€â”€â”€â”¼â”€â”€â”€â”€â–º users.id
â”‚ requested_role   â”‚
â”‚ status           â”‚  (pending | approved | rejected)
â”‚ requested_by     â”‚
â”‚ approved_by      â”‚
â”‚ rejected_by      â”‚
â”‚ approval_notes   â”‚
â”‚ rejection_reason â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PERMISSION RESOLUTION                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User wants to perform action "user:approve"
    â”‚
    â”œâ”€â–º Get user_id from JWT token
    â”‚
    â”œâ”€â–º Query user_roles WHERE user_id = ? AND is_active = true
    â”‚   â””â”€â–º role_ids: [role_1, role_2, ...]
    â”‚
    â”œâ”€â–º Query role_permissions WHERE role_id IN (role_1, role_2, ...) 
    â”‚                              AND granted = true
    â”‚   â””â”€â–º permission_ids: [perm_1, perm_2, ...]
    â”‚
    â”œâ”€â–º Query permissions WHERE id IN (perm_1, perm_2, ...) 
    â”‚                         AND is_active = true
    â”‚   â””â”€â–º permission_names: ['user:read', 'user:approve', ...]
    â”‚
    â””â”€â–º Check if 'user:approve' in permission_names
        â”œâ”€â–º YES âœ… â†’ Allow request
        â””â”€â–º NO  âŒ â†’ 403 Forbidden
```

---

## ğŸ¯ Complete User Journey Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               COMPLETE USER LIFECYCLE                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SUPER ADMIN (Bootstrap)
    â†“
    â”‚ Created via: node scripts/seed-rbac.js
    â”‚ Status: Approved
    â”‚ Role: super_admin
    â”‚ Can Login: âœ… Yes
    â”‚
    â”œâ”€â–º Can approve: âœ… Admins, Providers, Moderators
    â”œâ”€â–º Can create: âœ… Any resource
    â”œâ”€â–º Can delete: âœ… Any resource
    â””â”€â–º Can config: âœ… System settings


ADMIN (Requires Super Admin Approval)
    â†“
    â”‚ Created via: POST /api/auth/register/admin (by Super Admin)
    â”‚ Status: Pending â†’ Approved (by Super Admin)
    â”‚ Role: admin (after approval)
    â”‚ Can Login: âŒ No â†’ âœ… Yes (after approval)
    â”‚
    â”œâ”€â–º Can approve: âœ… Providers, Moderators
    â”œâ”€â–º Can create: âœ… Most resources (not system config)
    â”œâ”€â–º Can delete: âœ… Users, Products, etc.
    â””â”€â–º Can view: âœ… Analytics, Reports


MODERATOR (Requires Admin Approval)
    â†“
    â”‚ Created via: POST /api/auth/register
    â”‚ Status: Pending â†’ Approved (by Admin)
    â”‚ Role: moderator (after approval)
    â”‚ Can Login: âŒ No â†’ âœ… Yes (after approval)
    â”‚
    â”œâ”€â–º Can approve: âŒ No users
    â”œâ”€â–º Can verify: âœ… Providers, Users
    â”œâ”€â–º Can update: âœ… Status fields only
    â””â”€â–º Can view: âœ… Analytics


PROVIDER (Requires Admin Approval)
    â†“
    â”‚ Created via: POST /api/auth/register
    â”‚ Status: Pending â†’ Approved (by Admin)
    â”‚ Role: provider (after approval)
    â”‚ Can Login: âŒ No â†’ âœ… Yes (after approval)
    â”‚
    â”œâ”€â–º Can create: âœ… Quotes, Products
    â”œâ”€â–º Can manage: âœ… Own bookings
    â”œâ”€â–º Can view: âœ… Service requests
    â””â”€â–º Can process: âŒ Payments (view only)


CUSTOMER (Auto-Approved)
    â†“
    â”‚ Created via: POST /api/auth/register
    â”‚ Status: Approved (immediately)
    â”‚ Role: customer (immediately)
    â”‚ Can Login: âœ… Yes (immediately)
    â”‚
    â”œâ”€â–º Can create: âœ… Service requests, Bookings
    â”œâ”€â–º Can accept: âœ… Quotes
    â”œâ”€â–º Can pay: âœ… Process payments
    â””â”€â–º Can view: âœ… Public products/services


GUEST (No Account)
    â†“
    â”‚ No registration needed
    â”‚ Status: N/A
    â”‚ Role: guest (implicit)
    â”‚ Can Login: âŒ No account
    â”‚
    â”œâ”€â–º Can view: âœ… Products (read-only)
    â”œâ”€â–º Can view: âœ… Categories (read-only)
    â””â”€â–º Can create: âŒ Nothing


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPROVAL WORKFLOW STATES                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[User Registers]
        â”‚
        â–¼
    user_type?
        â”‚
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      â”‚                   â”‚
Customer                Provider            Admin
    â”‚                      â”‚                   â”‚
    â–¼                      â–¼                   â–¼
approval_status       approval_status     approval_status
= 'approved'          = 'pending'         = 'pending'
    â”‚                      â”‚                   â”‚
    â–¼                      â–¼                   â–¼
âœ… Role assigned       â³ No role yet       â³ No role yet
âœ… JWT tokens          âŒ No tokens         âŒ No tokens
âœ… Can login           âŒ Cannot login      âŒ Cannot login
    â”‚                      â”‚                   â”‚
    â”‚                      â–¼                   â–¼
    â”‚              [Admin Reviews]     [Super Admin Reviews]
    â”‚                      â”‚                   â”‚
    â”‚                      â–¼                   â–¼
    â”‚              Approve/Reject       Approve/Reject
    â”‚                      â”‚                   â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              â”‚               â”‚   â”‚               â”‚
    â”‚          Approved        Rejected  Approved   Rejected
    â”‚              â”‚               â”‚   â”‚               â”‚
    â”‚              â–¼               â–¼   â–¼               â–¼
    â”‚          âœ… Role        âŒ No    âœ… Role     âŒ No
    â”‚          assigned       access  assigned    access
    â”‚          âœ… Can login   âŒ Login âœ… Can      âŒ Login
    â”‚                         denied  login       denied
    â”‚
    â””â”€â”€â–º [All Can Use Platform According to Role Permissions]
```

---

**Diagram Version:** 1.0  
**Last Updated:** 2025-10-09  
**Note:** These diagrams are best viewed in a monospace font or markdown viewer

